USE QuanLyHoaDon


--TRIGGER TRÊN BẢNG HOADON CHO VIEC THEM SUA
GO
CREATE TRIGGER TG_TONGTIEN_FOR_INSERT_UPDATE_HOADON
ON HOADON FOR UPDATE
AS
BEGIN
	UPDATE HOADON
	SET HOADON.TONGTIEN = (SELECT SUM(CT.THANHTIEN)
							FROM CT_HOADON CT
							WHERE CT.MAHD = HOADON.MAHD
							GROUP BY CT.MAHD
							)
	WHERE HOADON.MAHD IN (SELECT DISTINCT inserted.MAHD
							FROM inserted)
END
GO

--TRIGGER TRÊN BẢNG CT_HOADON CHO VIEC THEM SUA
ALTER TRIGGER TG_TONGTIEN_FOR_INSERT_UPDATE_CTHD
ON CT_HOADON FOR UPDATE, INSERT
AS
BEGIN
	IF EXISTS(SELECT * FROM inserted
				WHERE inserted.GIAGIAM > inserted.GIABAN)
		BEGIN
			PRINT(N'Giá giảm không được vượt quá giá bán!')
			ROLLBACK
		END
	UPDATE CT_HOADON
	SET THANHTIEN = inserted.SOLUONG * (inserted.GIABAN - inserted.GIAGIAM)
	FROM CT_HOADON
	JOIN inserted ON inserted.MAHD = CT_HOADON.MAHD AND inserted.MASP = CT_HOADON.MASP
	
	-- Gọi trigger update tổng tiền trên bảng HOADON
	UPDATE HOADON
	SET HOADON.TONGTIEN = 0 
	WHERE HOADON.MAHD IN (SELECT DISTINCT inserted.MAHD
							FROM inserted)
END

GO
ALTER TRIGGER TG_TONGTIEN_FOR_DELETE_CTHD
ON CT_HOADON FOR DELETE
AS
BEGIN
	SELECT DISTINCT MAHD FROM deleted
	UPDATE HOADON
	SET HOADON.TONGTIEN -= (SELECT SUM(deleted.THANHTIEN)
							FROM deleted
							WHERE HOADON.MAHD = deleted.MAHD
							GROUP BY deleted.MAHD
							)
	WHERE HOADON.MAHD IN (SELECT DISTINCT MAHD
						FROM deleted)
END


--------------------------------------------------------------------------------------------------------
SELECT TOP 20 * FROM HOADON
SELECT TOP 20 * FROM CT_HOADON
GO
INSERT CT_HOADON VALUES('HD000000', 'SP000002', 3, 100000, 10000, 50000)

INSERT CT_HOADON VALUES('HD000000', 'SP000003', 2, 50000, 5000, 50000)
INSERT CT_HOADON VALUES('HD000000', 'SP000015', 2, 65000, 5000, 15000), ('HD000001', 'SP000012', 2, 75000, 5000, 30000)
-- INSERT CT_HOADON VALUES('HD000000', 'SP000006', 2, 65000, 5000, 17000), ('HD000001', 'SP000005', 2, 75000, 5000, 30000)
DELETE FROM CT_HOADON WHERE MAHD = 'HD000000' AND MASP IN ('SP000002', 'SP000003', 'SP000015')
UPDATE CT_HOADON SET GIAGIAM = 20000 WHERE MAHD = 'HD000000' AND MASP = 'SP000002'
UPDATE CT_HOADON SET THANHTIEN = 0 WHERE MAHD = 'HD000000' AND MASP = 'SP000002'
UPDATE HOADON SET TONGTIEN = 0 WHERE MAHD = 'HD000004'
UPDATE CT_HOADON SET THANHTIEN = 0 WHERE MAHD IN ('HD000000', 'HD000001', 'HD000002', 'HD000003')
DELETE FROM CT_HOADON WHERE (MAHD = 'HD000000' AND MASP = 'SP000015') OR (MAHD = 'HD000001' AND MASP = 'SP000012')


