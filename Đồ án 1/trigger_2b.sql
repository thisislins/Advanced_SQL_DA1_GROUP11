USE QuanLyHoaDon


--TRIGGER TRÊN BẢNG HOADON CHO VIEC THEM SUA
GO
CREATE TRIGGER TG_TONGTIEN_FOR_INSERT_UPDATE_HOADON
ON HOADON FOR INSERT, UPDATE
AS
BEGIN
	UPDATE HOADON
	SET TONGTIEN = (SELECT SUM(CT_HOADON.THANHTIEN)
					FROM CT_HOADON JOIN inserted ON (CT_HOADON.MAHD=inserted.MAHD)
					WHERE inserted.MAHD = HOADON.MAHD)
END
----

--TRIGGER TRÊN BẢNG CT_HOADON CHO VIEC THEM SUA

GO

ALTER TRIGGER TG_TONGTIEN_FOR_INSERT_UPDATE_CTHD
ON CT_HOADON FOR UPDATE, INSERT
AS
BEGIN
	UPDATE CT_HOADON
	SET THANHTIEN = inserted.SOLUONG * (inserted.GIABAN - inserted.GIAGIAM)
	FROM CT_HOADON
	JOIN inserted ON inserted.MAHD = CT_HOADON.MAHD AND inserted.MASP = CT_HOADON.MASP

	UPDATE HOADON
	SET HOADON.TONGTIEN = (SELECT SUM(CT.THANHTIEN)
							FROM CT_HOADON CT
							JOIN inserted 
							ON CT.MAHD = inserted.MAHD
							WHERE CT.MAHD = HOADON.MAHD
							GROUP BY CT.MAHD
							)
	WHERE HOADON.MAHD IN (SELECT DISTINCT inserted.MAHD
							FROM inserted)
END
GO
SELECT TOP 20 * FROM HOADON
SELECT TOP 20 * FROM CT_HOADON
GO
INSERT CT_HOADON VALUES('HD000000', 'SP000002', 3, 100000, 10000, 50000)

INSERT CT_HOADON VALUES('HD000000', 'SP000003', 2, 50000, 5000, 50000)
INSERT CT_HOADON VALUES('HD000000', 'SP000015', 2, 65000, 5000, 15000), ('HD000001', 'SP000012', 2, 75000, 5000, 30000)
-- INSERT CT_HOADON VALUES('HD000000', 'SP000006', 2, 65000, 5000, 17000), ('HD000001', 'SP000005', 2, 75000, 5000, 30000)
DELETE FROM CT_HOADON WHERE MAHD = 'HD000001' AND MASP IN ('SP000005', 'SP000011', 'SP000012')
UPDATE CT_HOADON SET THANHTIEN = 0 WHERE MAHD = 'HD000000'
--XOA 
GO
CREATE TRIGGER TG_TONGTIEN_FOR_DELETE_CTHD
ON CT_HOADON FOR DELETE
AS
BEGIN
	DECLARE @SUM MONEY = 0

	SELECT @SUM = (SELECT SUM(deleted.THANHTIEN) 
	FROM deleted JOIN HOADON HD ON (deleted.MAHD=HD.MAHD))

	UPDATE HOADON
	SET HOADON.TONGTIEN = @SUM
	WHERE HOADON.MAHD = MAHD
END
